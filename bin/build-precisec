#!/bin/sh
# grab flex options from from of command line.
while [ -n "$3" ]; do
    opts="$opts $1"
    shift
done
# at this point, there are only two items left on the command line.
cls=$1
name=$2
dir=as$name
# check java version
if java -version 2>&1 | grep -q 'version "1.1'; then
  echo "WARNING: YOU ARE USING JAVA 1.1. (JDK1.2 or above is preferred)" 1>&2
fi
# ok.
echo "Building $cls in $dir; result will be ${name}-Java.a" 1>&2
if [ -d $dir ]; then
    /bin/rm -rf $dir
fi
if [ ! -d $dir ]; then
    mkdir $dir
fi
# you can set FLEXPATH to assign additional components to the harpoon classpath
harpoonpath=${FLEXPATH}${FLEXPATH:+:}.:../Benchmarks:Support/Lex.jar:SupportNP/sunthunk.jar:SupportNP/collections.jar:SupportNP/classes.zip:Support/realtime.jar
if type -t cygpath > /dev/null ; then
    harpoonpath=`cygpath -wp "$harpoonpath"`
fi
java -Xmx512m -Dharpoon.class.path=$harpoonpath ${flexc_options:="-Dharpoon.alloc.strategy=bdw"} harpoon.Main.SAMain $opts -bprecisec -c $cls -o $dir && \
if [ -d ../Runtime/include -a -f ../Runtime/config.status ] && \
    grep -q "[-]-with-precise-c" ../Runtime/config.status ; then
    make -C $dir CC="gcc -I../../Runtime/include -g -O9" && \
    mv -f $dir/Java.a ../Runtime/${name}-Java.a && \
    make -C ../Runtime run${name} && \
    rm -f ../Runtime/${name}-Java.a && \
    echo "EXECUTABLE left in ../Runtime/run${name}." 1>&2
else
    echo "ASSEMBLY FILES left in $dir; see $dir/Makefile to build." 1>&2
fi
exit $?
