#!/usr/bin/perl
# unmunge.  Expects to find munged files on standard input.
# Pipeline safe.  Don't write output file until everything's read.
use File::Basename;

sub dumpstored {
    ($outfile, $contents)=@_;
    $dirname = dirname($outfile);
    system('mkdir -p ' . $dirname) unless -d $dirname;
    open(FH, "> $outfile") or die "Can't open $outfile for writing.\n";
    print FH $contents;
    close FH;
}

undef $outfile;
$contents="";
LINE: while (<>) {
    if (/^---- CUT HERE ----/) {
	dumpstored $outfile, $contents if defined($outfile);
	$outfile = <>; # read next line.
	chomp $outfile;
	print "$outfile\n";
	$contents="";
	next LINE;
    }
    s/^- /-/g;
    $contents .= $_;
}
dumpstored $outfile, $contents if defined($outfile);
